<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AES-256-GCM + æ—¥æ–‡Base åŠ è§£å¯†å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å…ˆåŠ è½½ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    
    <style>
        body {
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.10);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            width: 0%;
            transition: width 0.3s ease;
        }
        #dragOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            font-weight: bold;
            z-index: 1000;
            pointer-events: none;
        }
        .process-progress {
            display: none;
            margin-top: 1rem;
        }
        .process-progress.active {
            display: block;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .processing {
            animation: pulse 1.5s ease-in-out infinite;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }
        .toast.show { opacity: 1; }
        
        /* çœ‹æ¿å¨˜è‡ªå®šä¹‰æ ·å¼ */
        .live2d-widget-container {
            position: fixed !important;
            bottom: 0;
            right: 0;
            z-index: 9999 !important;
            pointer-events: auto !important;
        }
        
        /* æ§åˆ¶æŒ‰é’®æ ·å¼ */
        #live2d-controls {
            position: fixed;
            bottom: 100px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10000;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .live2d-control-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s;
            margin-bottom: 5px;
        }
        
        .live2d-control-btn:hover {
            transform: scale(1.1);
        }
        
        .live2d-control-btn.switch { background: #3b82f6; }
        .live2d-control-btn.toggle { background: #10b981; }
        .live2d-control-btn.talk { background: #f59e0b; }
        
        /* æ¨¡å‹é€‰æ‹©å™¨æ ·å¼ */
        #live2d-model-selector {
            position: fixed;
            bottom: 150px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 10001;
            max-width: 220px;
            max-height: 400px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0,0,0,0.1);
            display: none;
        }
        
        .model-selector-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .model-library-section {
            margin-bottom: 12px;
        }
        
        .library-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            padding-bottom: 3px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .model-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 6px 10px;
            margin: 3px 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            color: #333;
        }
        
        .model-btn:hover {
            background: #f0f7ff;
            border-color: #3b82f6;
        }
        
        .close-selector-btn {
            width: 100%;
            padding: 8px;
            background: #f5f5f5;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
            color: #666;
        }
        
        .close-selector-btn:hover {
            background: #e5e5e5;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div id="dragOverlay">æ‹–å…¥æ–‡ä»¶åˆ°æ­¤å¤„å¯¼å…¥</div>
    
    <!-- çœ‹æ¿å¨˜å®¹å™¨ -->
    <div id="live2d-widget" style="position: fixed; right: 0; bottom: 0; z-index: 9998;"></div>
    
    <div class="glass rounded-xl shadow-2xl p-6 max-w-2xl w-full relative">
        <div id="loadingSpinner" class="loading">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        </div>
        
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">ğŸ” AES-256-GCM + æ—¥æ–‡Base åŠ è§£å¯†å·¥å…·</h1>
        <p class="text-center text-gray-600 text-sm mb-6">æµå¼åˆ†å— Â· æ”¯æŒç™¾GB+ Â· çº¯å‰ç«¯ Â· å¦‚é‡è¶…è¿‡2Gæ— æ³•è§£å¯†è¯·ä½¿ç”¨Chrome / Edge</p>
        
        <div class="mb-6 text-center">
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                <span class="w-2 h-2 bg-blue-600 rounded-full mr-2"></span>
                <span id="modeText">å½“å‰æ¨¡å¼ï¼šåŠ å¯†</span>
            </span>
        </div>
        
        <div class="mb-6 bg-gray-50 rounded-lg p-4 border">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-700">å¯†é’¥è®¾ç½®</h3>
                <button type="button" id="toggleAdvanced" class="text-sm text-blue-600 hover:text-blue-800">
                    æ˜¾ç¤ºé«˜çº§é€‰é¡¹
                </button>
            </div>
            <div class="mb-4">
                <label class="inline-flex items-center">
                    <input id="useCustomKey" type="checkbox" class="form-checkbox h-5 w-5 text-blue-600">
                    <span class="ml-2 text-sm font-medium text-gray-600">å¯ç”¨è‡ªå®šä¹‰å¯†é’¥</span>
                </label>
                <p class="text-xs text-gray-500 ml-7 mt-1">ä¸å¯ç”¨åˆ™ä½¿ç”¨é»˜è®¤å¯†é’¥</p>
            </div>
            <div id="keyInputContainer" class="mb-4 hidden">
                <label class="block text-sm font-medium text-gray-600 mb-1">è¾“å…¥å¯†é’¥/å¯†ç </label>
                <div class="relative">
                    <input id="keyInput" type="password" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="å»ºè®®12ä½ä»¥ä¸Šï¼Œå«å¤§å°å†™+æ•°å­—+ç¬¦å·">
                    <button type="button" id="toggleKeyVisibility" class="absolute right-3 top-3 text-gray-500 hover:text-gray-700">
                        ğŸ‘ï¸
                    </button>
                </div>
                <div class="flex items-center mt-2">
                    <div class="progress-bar flex-1">
                        <div id="keyStrengthBar" class="progress-fill"></div>
                    </div>
                    <span id="keyStrengthText" class="ml-2 text-xs text-gray-500">å¯†é’¥å¼ºåº¦</span>
                </div>
            </div>
            <div id="advancedOptions" class="hidden space-y-4 mt-4 pt-4 border-t">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">ç›å€¼ï¼ˆSaltï¼Œå¯é€‰åå…­è¿›åˆ¶ï¼‰</label>
                    <input id="saltInput" type="text" class="w-full p-2 border rounded-md"
                           placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆéšæœºç›å€¼">
                    <p class="text-xs text-gray-500 mt-1">è‡ªå®šä¹‰ç›å€¼éœ€åœ¨è§£å¯†æ—¶æ‰‹åŠ¨è¾“å…¥ç›¸åŒå€¼</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">è¿­ä»£æ¬¡æ•°</label>
                    <input id="iterationsInput" type="number" value="200000" min="1000" max="1000000"
                           class="w-full p-2 border rounded-md">
                    <p class="text-xs text-gray-500 mt-1">é»˜è®¤200000ï¼Œæ›´é«˜æ›´å®‰å…¨ä½†é€Ÿåº¦ç¨æ…¢</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">åˆ†å—å¤§å°ï¼ˆMBï¼‰</label>
                    <input id="chunkSize" type="number" value="20" min="1" max="500"
                           class="w-full p-2 border rounded-md">
                    <p class="text-xs text-gray-500 mt-1">å»ºè®®10-500MBï¼Œè¶Šå¤§é€Ÿåº¦è¶Šå¿«ï¼Œä½†å†…å­˜å ç”¨æ›´é«˜ï¼ˆå¤§æ–‡ä»¶æ¨èChrome/Edgeï¼‰</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">åŠ å¯†è¾“å‡ºæ–¹å¼</label>
                    <select id="encryptOutputMode" class="w-full p-2 border rounded-md">
                        <option value="text">æ˜¾ç¤ºæ—¥æ–‡å¯†æ–‡ï¼ˆé€‚åˆå°æ–‡ä»¶ï¼‰</option>
                        <option value="file">ä¿å­˜ä¸ºæ–‡ä»¶ï¼ˆé€‚åˆå¤§æ–‡ä»¶ï¼‰</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">å¤§æ–‡ä»¶å»ºè®®é€‰æ‹©ä¿å­˜ä¸ºæ–‡ä»¶ï¼Œé¿å…å†…å­˜å ç”¨è¿‡é«˜</p>
                </div>
            </div>
        </div>
        
        <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
                <label id="inputLabel" class="block text-sm font-medium text-gray-600">è¾“å…¥æ˜æ–‡æˆ–ä»»æ„æ–‡ä»¶</label>
                <span id="charCount" class="text-sm text-gray-500">0 å­—ç¬¦</span>
            </div>
            <textarea id="inputText" rows="5"
                      class="w-full p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                      placeholder="åŠ å¯†è¯·è¾“å…¥æ˜æ–‡æˆ–å¯¼å…¥ä»»æ„æ–‡ä»¶ï¼Œè§£å¯†å¯ç²˜è´´æ—¥æ–‡å¯†æ–‡æˆ–å¯¼å…¥.encæ–‡ä»¶"></textarea>
            <div class="mt-2">
                <label class="bg-blue-500 text-white px-4 py-2 rounded cursor-pointer hover:bg-blue-600 inline-block">
                    ğŸ“ é€‰æ‹©æ–‡ä»¶ï¼ˆæ”¯æŒä»»æ„å¤§å°ï¼‰ <input type="file" id="importFile" class="hidden" accept="*/*">
                </label>
            </div>
            <p id="inputInfo" class="text-sm text-gray-500 mt-1"></p>
        </div>
        
        <div class="process-progress" id="processProgress">
            <div class="bg-gray-100 rounded-lg p-4 border">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">å¤„ç†è¿›åº¦</span>
                    <span id="progressPercent" class="text-sm font-medium text-blue-600">0%</span>
                </div>
                <div class="progress-bar h-6">
                    <div id="progressFill" class="progress-fill bg-gradient-to-r from-blue-500 to-purple-500"></div>
                </div>
                <div class="mt-2 text-xs text-gray-600 space-y-1">
                    <div class="flex justify-between"><span>å·²å¤„ç†ï¼š</span><span id="processedSize" class="font-medium">0 MB</span></div>
                    <div class="flex justify-between"><span>æ€»å¤§å°ï¼š</span><span id="totalSize" class="font-medium">0 MB</span></div>
                    <div class="flex justify-between"><span>é¢„è®¡å‰©ä½™æ—¶é—´ï¼š</span><span id="remainingTime" class="font-medium">è®¡ç®—ä¸­...</span></div>
                </div>
            </div>
        </div>
        
        <div class="flex flex-wrap justify-center gap-3 mb-6">
            <button id="encryptButton" class="flex-1 min-w-[120px] bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-medium flex items-center justify-center">
                <span>ğŸ”’</span><span class="ml-2">åŠ å¯†</span>
            </button>
            <button id="decryptButton" class="flex-1 min-w-[120px] bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 font-medium flex items-center justify-center">
                <span>ğŸ”“</span><span class="ml-2">è§£å¯†</span>
            </button>
            <button id="clearButton" class="flex-1 min-w-[120px] bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 font-medium flex items-center justify-center">
                <span>ğŸ—‘ï¸</span><span class="ml-2">æ¸…ç©º</span>
            </button>
        </div>
        
        <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
                <label id="outputLabel" class="block text-sm font-medium text-gray-600">ç»“æœ</label>
            </div>
            <div id="outputContainer" class="w-full border rounded-lg bg-gray-50 overflow-hidden">
                <textarea id="outputText" rows="5" class="w-full p-4 font-mono text-base hidden" readonly></textarea>
                <img id="outputImage" class="max-w-full h-auto hidden" alt="è§£å¯†å›¾ç‰‡é¢„è§ˆ">
            </div>
            <div id="outputInfo" class="mt-3 space-y-2">
                <div class="flex justify-between text-sm"><span class="text-gray-600">æ“ä½œçŠ¶æ€ï¼š</span><span id="operationStatus" class="text-gray-800">å°±ç»ª</span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-600">æ•°æ®å¤§å°ï¼š</span><span id="dataSize" class="text-gray-800">-</span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-600">å¤„ç†æ—¶é—´ï¼š</span><span id="processingTime" class="text-gray-800">-</span></div>
            </div>
        </div>
        
        <div class="flex flex-wrap justify-center gap-3">
            <button id="copyButton" class="flex-1 min-w-[140px] bg-emerald-500 text-white py-3 px-4 rounded-lg hover:bg-emerald-600 hidden">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
            <button id="downloadButton" class="flex-1 min-w-[140px] bg-purple-500 text-white py-3 px-4 rounded-lg hover:bg-purple-600 hidden">â¬‡ï¸ ä¸‹è½½æ–‡ä»¶</button>
            <button id="showDetailsButton" class="flex-1 min-w-[140px] bg-amber-500 text-white py-3 px-4 rounded-lg hover:bg-amber-600 hidden">ğŸ” æŸ¥çœ‹è¯¦æƒ…</button>
        </div>
        
        <div id="detailsModal" class="hidden fixed inset-0 flex items-center justify-center z-50">
            <div class="absolute inset-0 bg-black bg-opacity-50" id="modalBackdrop"></div>
            <div class="glass rounded-xl p-6 max-w-lg w-full mx-4 relative z-10">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">AES-256-GCM åŠ è§£å¯†è¯¦æƒ…</h3>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
                </div>
                <div class="space-y-3">
                    <div><span class="text-sm text-gray-600">ç‰ˆæœ¬ï¼š</span><span id="modalVersion" class="text-sm font-mono">-</span></div>
                    <div><span class="text-sm text-gray-600">è¿­ä»£æ¬¡æ•°ï¼š</span><span id="modalIterations" class="text-sm font-mono">-</span></div>
                    <div><span class="text-sm text-gray-600">MIMEç±»å‹ï¼š</span><span id="modalMime" class="text-sm font-mono">-</span></div>
                    <div><span class="text-sm text-gray-600">Nonceï¼ˆå‰8å­—èŠ‚ï¼‰ï¼š</span><span id="modalNonce" class="text-sm font-mono break-all">-</span></div>
                    <div><span class="text-sm text-gray-600">ç›å€¼ï¼š</span><span id="modalSalt" class="text-sm font-mono break-all">-</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================== Live2D çœ‹æ¿å¨˜é…ç½® ==================
        
        // æ¨¡å‹åº“é…ç½®
        const modelLibraries = {
            akilar: {
                name: "Akilar Live2D API",
                baseUrl: "https://npm.elemecdn.com/akilar-live2dapi@latest/model/",
                models: [
                    { name: "é»‘çŒ«", path: "hijiki/hijiki.model.json" },
                    { name: "ç™½çŒ«", path: "tororo/tororo.model.json" },
                    { name: "å°æ˜¥", path: "koharu/koharu.model.json" },
                    { name: "è¡€å°æ¿", path: "platelet/platelet.model.json" },
                    { name: "æƒ æƒ ", path: "miku/miku.model.json" },
                    { name: "å”¯", path: "yui/yui.model.json" }
                ]
            },
            zhanghongtu: {
                name: "zhanghongtu æ¨¡å‹åº“",
                baseUrl: "https://cdn.jsdelivr.net/gh/zenghongtu/live2d-model-assets/",
                models: [
                    { name: "åˆéŸ³æœªæ¥", path: "miku/miku.model.json" },
                    { name: "è¡€å°æ¿", path: "xiaoban/xiaoban.model.json" },
                    { name: "æƒ æƒ ", path: "huihui/huihui.model.json" },
                    { name: "ç™½", path: "bai/bai.model.json" },
                    { name: "é»‘", path: "hei/hei.model.json" },
                    { name: "çŒ«å¨˜", path: "maoniang/maoniang.model.json" }
                ]
            }
        };

        // å½“å‰æ¨¡å‹ç´¢å¼•
        let currentModelIndex = {
            library: 'akilar',
            modelIndex: 2 // é»˜è®¤é€‰æ‹©å°æ˜¥
        };

        // åˆ›å»ºæ¨¡å‹é€‰æ‹©å™¨
        function createModelSelector() {
            const selector = document.createElement('div');
            selector.id = 'live2d-model-selector';
            selector.innerHTML = `
                <div class="model-selector-title">åˆ‡æ¢çœ‹æ¿å¨˜æ¨¡å‹</div>
            `;

            Object.entries(modelLibraries).forEach(([libKey, library]) => {
                const section = document.createElement('div');
                section.className = 'model-library-section';
                
                const title = document.createElement('div');
                title.className = 'library-title';
                title.textContent = library.name;
                section.appendChild(title);
                
                library.models.forEach((model, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'model-btn';
                    btn.textContent = model.name;
                    btn.onclick = () => {
                        switchModel(libKey, index);
                        selector.style.display = 'none';
                        showMessage(`å·²åˆ‡æ¢æ¨¡å‹: ${model.name}`, 'info');
                    };
                    section.appendChild(btn);
                });
                
                selector.appendChild(section);
            });

            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-selector-btn';
            closeBtn.textContent = 'å…³é—­';
            closeBtn.onclick = () => selector.style.display = 'none';
            selector.appendChild(closeBtn);

            document.body.appendChild(selector);
            return selector;
        }

        // åˆ›å»ºæ§åˆ¶æŒ‰é’®
        function createControlButtons() {
            const container = document.createElement('div');
            container.id = 'live2d-controls';

            // åˆ‡æ¢æ¨¡å‹æŒ‰é’®
            const switchBtn = document.createElement('button');
            switchBtn.className = 'live2d-control-btn switch';
            switchBtn.innerHTML = '<i class="fa fa-refresh"></i>';
            switchBtn.title = 'åˆ‡æ¢æ¨¡å‹';
            switchBtn.onclick = () => {
                const selector = document.getElementById('live2d-model-selector');
                if (selector) {
                    selector.style.display = selector.style.display === 'none' ? 'block' : 'none';
                }
            };

            // éšè—/æ˜¾ç¤ºæŒ‰é’®
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'live2d-control-btn toggle';
            toggleBtn.innerHTML = '<i class="fa fa-eye-slash"></i>';
            toggleBtn.title = 'éšè—/æ˜¾ç¤ºçœ‹æ¿å¨˜';
            toggleBtn.onclick = () => {
                const widget = document.getElementById('live2d-widget');
                if (widget) {
                    const isHidden = widget.style.display === 'none';
                    widget.style.display = isHidden ? 'block' : 'none';
                    toggleBtn.innerHTML = isHidden ? 
                        '<i class="fa fa-eye-slash"></i>' : '<i class="fa fa-eye"></i>';
                    toggleBtn.title = isHidden ? 'éšè—çœ‹æ¿å¨˜' : 'æ˜¾ç¤ºçœ‹æ¿å¨˜';
                }
            };

            // å¯¹è¯æŒ‰é’®
            const talkBtn = document.createElement('button');
            talkBtn.className = 'live2d-control-btn talk';
            talkBtn.innerHTML = '<i class="fa fa-comment"></i>';
            talkBtn.title = 'éšæœºå¯¹è¯';
            talkBtn.onclick = () => {
                const messages = [
                    'åŠ å¯†å·¥å…·ä½¿ç”¨æ„‰å¿«ï¼ğŸ”',
                    'è®°å¾—ä¿å­˜å¥½å¯†é’¥å“¦ï½',
                    'å®‰å…¨ç¬¬ä¸€ï¼è¦ä¿æŠ¤é‡è¦æ•°æ®ï¼',
                    'æˆ‘å¯ä»¥é™ªä½ ä¸€èµ·å·¥ä½œå‘¢ï¼',
                    'è¦å¥½å¥½ä¿æŠ¤éšç§æ•°æ®ï¼',
                    'åŠ å¯†å®Œæˆäº†å—ï¼Ÿå¥½å‰å®³ï¼',
                    'è§£å¯†æˆåŠŸï¼æ•°æ®æ¢å¤å•¦ï¼',
                    'è®°å¾—ä½¿ç”¨å¼ºå¯†ç æ›´å®‰å…¨ï¼'
                ];
                const randomMsg = messages[Math.floor(Math.random() * messages.length)];
                showMessage(`çœ‹æ¿å¨˜: ${randomMsg}`, 'info');
            };

            container.appendChild(switchBtn);
            container.appendChild(toggleBtn);
            container.appendChild(talkBtn);
            document.body.appendChild(container);

            return container;
        }

        // åˆ‡æ¢æ¨¡å‹å‡½æ•°
        function switchModel(libraryKey, modelIndex) {
            const library = modelLibraries[libraryKey];
            if (!library || !library.models[modelIndex]) return;
            
            const model = library.models[modelIndex];
            const modelUrl = library.baseUrl + model.path;
            
            currentModelIndex = { library: libraryKey, modelIndex: modelIndex };
            
            // ç§»é™¤æ—§çš„çœ‹æ¿å¨˜
            const oldWidget = document.getElementById('live2d-widget');
            if (oldWidget) {
                oldWidget.innerHTML = '';
            }
            
            // åŠ è½½æ–°çš„çœ‹æ¿å¨˜
            loadLive2DWidget(modelUrl);
        }

        // åŠ è½½çœ‹æ¿å¨˜
        function loadLive2DWidget(modelUrl) {
            const widgetDiv = document.getElementById('live2d-widget');
            if (!widgetDiv) return;
            
            // è®¾ç½®çœ‹æ¿å¨˜æ ·å¼
            widgetDiv.style.cssText = `
                position: fixed;
                right: 0;
                bottom: 0;
                width: 280px;
                height: 320px;
                z-index: 9998;
                pointer-events: none;
            `;
            
            // åˆ›å»ºiframeæˆ–ä½¿ç”¨å…¶ä»–æ–¹å¼åŠ è½½Live2D
            // è¿™é‡Œä½¿ç”¨ç®€å•çš„å›¾ç‰‡ä½œä¸ºæ›¿ä»£ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦åŠ è½½çœŸæ­£çš„Live2D
            widgetDiv.innerHTML = `
                <div style="position: absolute; right: 0; bottom: 0; pointer-events: auto;">
                    <div style="position: relative;">
                        <div style="
                            width: 280px;
                            height: 320px;
                            background: url('https://npm.elemecdn.com/akilar-live2dapi@latest/assets/koharu.png') center/contain no-repeat;
                            cursor: pointer;
                            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.2));
                        " onclick="showMessage('çœ‹æ¿å¨˜: åˆ«æˆ³æˆ‘å•¦ï½', 'info')"></div>
                        <div style="
                            position: absolute;
                            bottom: 10px;
                            right: 10px;
                            background: rgba(255,255,255,0.9);
                            padding: 5px 10px;
                            border-radius: 15px;
                            font-size: 12px;
                            color: #333;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                        ">
                            ${modelUrl.includes('koharu') ? 'å°æ˜¥' : 
                              modelUrl.includes('miku') ? 'åˆéŸ³æœªæ¥' : 
                              modelUrl.includes('tororo') ? 'ç™½çŒ«' : 
                              modelUrl.includes('hijiki') ? 'é»‘çŒ«' : 'çœ‹æ¿å¨˜'}
                        </div>
                    </div>
                </div>
            `;
        }

        // å·¥å…·å‡½æ•°
        function showMessage(msg, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type} show`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // åˆå§‹åŒ–çœ‹æ¿å¨˜
        function initLive2D() {
            // åˆ›å»ºæ§åˆ¶UI
            createModelSelector();
            createControlButtons();
            
            // åŠ è½½é»˜è®¤æ¨¡å‹
            setTimeout(() => {
                const defaultModel = modelLibraries.akilar.models[2]; // å°æ˜¥
                loadLive2DWidget(modelLibraries.akilar.baseUrl + defaultModel.path);
            }, 100);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–çœ‹æ¿å¨˜
        document.addEventListener('DOMContentLoaded', function() {
            initLive2D();
        });

        // ================== AES åŠ å¯†å·¥å…·ä»£ç  ==================
        
        const CURRENT_VERSION = 26;
        const MAGIC_BYTE = 0xF7;
        const SEPARATOR_BYTE = 0x00;
        const MAX_MIME_LEN = 255;
        const GCM_TAG_LEN = 16;
        const GCM_IV_LEN = 12;
        const FILE_NONCE_LEN = 8;
        const TWO_GB = 2 * 1024 * 1024 * 1024;
        const LARGE_TEXT_THRESHOLD = 5 * 1024 * 1024;

        const supportsSavePicker = typeof window.showSaveFilePicker === 'function';

        // æ—¥æ–‡ Base ç¼–ç 
        const customAlphabet = 'ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚ã‚‘ã‚’ã‚“ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿';
        const paddingChar = 'ãƒ³';
        if (customAlphabet.length !== 64) throw new Error('å­—æ¯è¡¨å¿…é¡»64ä½');
        const encodeMap = new Map();
        const decodeMap = new Map();
        for (let i = 0; i < 64; i++) {
            encodeMap.set(i, customAlphabet[i]);
            decodeMap.set(customAlphabet[i], i);
        }

        function customBaseEncode(bytes) {
            let out = '';
            for (let i = 0; i < bytes.length; i += 3) {
                const b1 = bytes[i];
                const b2 = i + 1 < bytes.length ? bytes[i + 1] : 0;
                const b3 = i + 2 < bytes.length ? bytes[i + 2] : 0;
                const e1 = b1 >> 2;
                const e2 = ((b1 & 3) << 4) | (b2 >> 4);
                const e3 = ((b2 & 15) << 2) | (b3 >> 6);
                const e4 = b3 & 63;
                if (i + 1 >= bytes.length) out += encodeMap.get(e1) + encodeMap.get(e2) + paddingChar + paddingChar;
                else if (i + 2 >= bytes.length) out += encodeMap.get(e1) + encodeMap.get(e2) + encodeMap.get(e3) + paddingChar;
                else out += encodeMap.get(e1) + encodeMap.get(e2) + encodeMap.get(e3) + encodeMap.get(e4);
            }
            return out;
        }

        function customBaseDecode(str) {
            str = str.replace(/\s/g, '');
            if (str.length % 4 !== 0) throw new Error('å¯†æ–‡é•¿åº¦å¿…é¡»ä¸º4çš„å€æ•°');
            const padIndex = str.indexOf(paddingChar);
            if (padIndex !== -1 && !str.slice(padIndex).match(/^ãƒ³{0,2}$/)) {
                throw new Error('éæ³•å¯†æ–‡ï¼špaddingé”™è¯¯');
            }
            let padding = 0;
            if (str.endsWith(paddingChar + paddingChar)) padding = 2;
            else if (str.endsWith(paddingChar)) padding = 1;
            const outLen = (str.length / 4) * 3 - padding;
            const out = new Uint8Array(outLen);
            let outIdx = 0;
            for (let i = 0; i < str.length; i += 4) {
                const c1 = decodeMap.get(str[i]);
                const c2 = decodeMap.get(str[i+1]);
                const c3 = str[i+2] === paddingChar ? 0 : decodeMap.get(str[i+2]);
                const c4 = str[i+3] === paddingChar ? 0 : decodeMap.get(str[i+3]);
                if (c1 === undefined || c2 === undefined ||
                    (str[i+2] !== paddingChar && c3 === undefined) ||
                    (str[i+3] !== paddingChar && c4 === undefined)) {
                    throw new Error(`å¯†æ–‡åŒ…å«éæ³•å­—ç¬¦ï¼ˆä½ç½®çº¦${i+1}ï¼‰`);
                }
                if (outIdx < outLen) out[outIdx++] = (c1 << 2) | (c2 >> 4);
                if (outIdx < outLen) out[outIdx++] = ((c2 & 15) << 4) | (c3 >> 2);
                if (outIdx < outLen) out[outIdx++] = ((c3 & 3) << 6) | c4;
            }
            return out;
        }

        async function deriveKey(password, salt, iterations) {
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveBits"]);
            const derivedBits = await crypto.subtle.deriveBits({
                name: "PBKDF2",
                salt: salt,
                iterations: iterations,
                hash: "SHA-256"
            }, keyMaterial, 256);
            return await crypto.subtle.importKey("raw", derivedBits, { name: "AES-GCM" }, false, ["encrypt", "decrypt"]);
        }

        function evaluateKeyStrength(pass) {
            if (!pass) return { percent: 0, text: 'æ— ', color: 'text-red-600' };
            let score = 0;
            if (pass.length >= 12) score += 25;
            if (pass.length >= 20) score += 15;
            if (/[a-z]/.test(pass)) score += 15;
            if (/[A-Z]/.test(pass)) score += 15;
            if (/[0-9]/.test(pass)) score += 15;
            if (/[^a-zA-Z0-9]/.test(pass)) score += 15;
            const texts = ['æå¼±', 'å¼±', 'ä¸­ç­‰', 'è¾ƒå¼º', 'å¼º', 'æå¼º'];
            const colors = ['text-red-600', 'text-orange-600', 'text-yellow-600', 'text-green-500', 'text-green-600', 'text-green-700'];
            const idx = Math.min(5, Math.floor(score / 20));
            return { percent: Math.max(10, score), text: texts[idx], color: colors[idx] };
        }

        function getTimestampFilename(base, ext) {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            return `${base}_${yyyy}${mm}${dd}_${hh}${min}${ss}${ext}`;
        }

        function getExtensionFromMime(mime) {
            const map = {
                'text/plain': '.txt',
                'text/html': '.html',
                'text/css': '.css',
                'text/javascript': '.js',
                'application/javascript': '.js',
                'application/json': '.json',
                'application/xml': '.xml',
                'text/csv': '.csv',
                'text/markdown': '.md',
                'application/x-sh': '.sh',
                'text/yaml': '.yaml',
                'text/tsv': '.tsv',
                'text/richtext': '.rtx',
                'application/x-tex': '.tex',
                'text/xml': '.xml',
                'application/rss+xml': '.rss',
                'application/atom+xml': '.atom',
                'text/x-log': '.log',
                'image/jpeg': '.jpg',
                'image/pjpeg': '.jpg',
                'image/png': '.png',
                'image/gif': '.gif',
                'image/webp': '.webp',
                'image/svg+xml': '.svg',
                'image/bmp': '.bmp',
                'image/tiff': '.tiff',
                'image/x-icon': '.ico',
                'image/heic': '.heic',
                'image/heif': '.heif',
                'image/avif': '.avif',
                'image/vnd.adobe.photoshop': '.psd',
                'image/vnd.microsoft.icon': '.ico',
                'image/x-canon-cr2': '.cr2',
                'image/x-nikon-nef': '.nef',
                'image/x-sony-arw': '.arw',
                'image/x-panasonic-rw2': '.rw2',
                'image/x-portable-pixmap': '.ppm',
                'image/x-rgb': '.rgb',
                'image/vnd.djvu': '.djvu',
                'audio/mpeg': '.mp3',
                'audio/wav': '.wav',
                'audio/ogg': '.ogg',
                'audio/flac': '.flac',
                'audio/mp4': '.m4a',
                'audio/webm': '.weba',
                'audio/aac': '.aac',
                'audio/amr': '.amr',
                'audio/x-wav': '.wav',
                'audio/x-m4a': '.m4a',
                'audio/midi': '.midi',
                'audio/x-midi': '.midi',
                'audio/x-ms-wma': '.wma',
                'audio/x-aiff': '.aiff',
                'audio/basic': '.au',
                'video/mp4': '.mp4',
                'video/webm': '.webm',
                'video/ogg': '.ogv',
                'video/x-matroska': '.mkv',
                'video/quicktime': '.mov',
                'video/avi': '.avi',
                'video/msvideo': '.avi',
                'video/x-flv': '.flv',
                'video/mpeg': '.mpeg',
                'video/x-ms-wmv': '.wmv',
                'video/x-msvideo': '.avi',
                'video/3gpp': '.3gp',
                'video/3gpp2': '.3g2',
                'video/x-ms-asf': '.asf',
                'video/x-m4v': '.m4v',
                'video/vnd.dlna.mpeg-tts': '.ts',
                'application/zip': '.zip',
                'application/x-7z-compressed': '.7z',
                'application/x-rar-compressed': '.rar',
                'application/x-tar': '.tar',
                'application/gzip': '.gz',
                'application/x-bzip2': '.bz2',
                'application/x-xz': '.xz',
                'application/x-lzh-compressed': '.lzh',
                'application/x-cbr': '.cbr',
                'application/x-cbz': '.cbz',
                'application/x-arj': '.arj',
                'application/x-zip-compressed': '.zip',
                'application/x-gzip': '.gz',
                'application/x-bzip': '.bz',
                'application/vnd.rar': '.rar',
                'application/pdf': '.pdf',
                'application/msword': '.doc',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document': '.docx',
                'application/vnd.ms-excel': '.xls',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': '.xlsx',
                'application/vnd.ms-powerpoint': '.ppt',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation': '.pptx',
                'application/rtf': '.rtf',
                'application/epub+zip': '.epub',
                'application/vnd.oasis.opendocument.text': '.odt',
                'application/vnd.oasis.opendocument.spreadsheet': '.ods',
                'application/vnd.oasis.opendocument.presentation': '.odp',
                'application/vnd.apple.pages': '.pages',
                'application/vnd.apple.numbers': '.numbers',
                'application/vnd.apple.keynote': '.key',
                'application/vnd.mozilla.xul+xml': '.xul',
                'application/vnd.visio': '.vsd',
                'application/vnd.stardivision.writer': '.sdw',
                'application/vnd.stardivision.calc': '.sdc',
                'application/vnd.ms-access': '.mdb',
                'application/vnd.ms-project': '.mpp',
                'application/vnd.lotus-wordpro': '.lwp',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.template': '.dotx',
                'font/woff': '.woff',
                'font/woff2': '.woff2',
                'application/font-woff': '.woff',
                'application/font-woff2': '.woff2',
                'font/ttf': '.ttf',
                'font/otf': '.otf',
                'application/vnd.ms-fontobject': '.eot',
                'font/collection': '.ttc',
                'font/sfnt': '.ttf',
                'application/octet-stream': '.bin',
                'application/x-msdownload': '.exe',
                'application/vnd.android.package-archive': '.apk',
                'application/x-msinstaller': '.msi',
                'application/x-dosexec': '.exe',
                'application/x-mach-binary': '.bin',
                'application/x-elf': '.elf',
                'application/java-archive': '.jar',
                'application/x-shockwave-flash': '.swf',
                'application/x-msclip': '.clp',
                'application/x-silverlight-app': '.xap',
                'application/sql': '.sql',
                'application/x-sqlite3': '.sqlite',
                'application/vnd.sqlite3': '.sqlite',
                'application/vnd.ms-access': '.mdb',
                'application/vnd.ms-access.addin.mda': '.mda',
                'application/vnd.ms-access.template.mdt': '.mdt',
                'application/vnd.ms-access.addin.mda': '.mda',
                'application/vnd.ms-access.runtime': '.accdr',
                'application/x-msaccess': '.mdb',
                'application/vnd.symbian.install': '.sis',
                'model/stl': '.stl',
                'model/iges': '.igs',
                'model/step+xml': '.stp',
                'model/obj': '.obj',
                'application/vnd.autocad.dwg': '.dwg',
                'application/vnd.autocad.dxf': '.dxf',
                'model/vnd.collada+xml': '.dae',
                'model/x3d+xml': '.x3d',
                'model/gltf+json': '.gltf',
                'model/gltf-binary': '.glb',
                'application/x-nikon-nef': '.nef',
                'application/x-canon-cr2': '.cr2',
                'application/x-sony-arw': '.arw',
                'application/x-panasonic-rw2': '.rw2',
                'application/x-fujifilm-raf': '.raf',
                'application/x-olympus-orf': '.orf',
                'application/octet-stream': '.bin',
                'application/x-freearc': '.arc',
                'application/vnd.google-earth.kml+xml': '.kml',
                'application/vnd.google-earth.kmz': '.kmz',
                'application/x-font-ttf': '.ttf',
                'audio/x-aac': '.aac'
            };

            return map[mime] || '';
        }

        function isLikelyText(bytes) {
            try {
                const decoded = new TextDecoder('utf-8', { fatal: true }).decode(bytes.subarray(0, Math.min(1024, bytes.length)));
                return !/[\x00-\x08\x0E-\x1F]/.test(decoded);
            } catch { return false; }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTime(seconds) {
            seconds = Math.max(0, Math.floor(seconds));
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            if (h > 0) return `${h}å°æ—¶ ${m}åˆ†é’Ÿ`;
            if (m > 0) return `${m}åˆ†é’Ÿ ${s}ç§’`;
            return `${s}ç§’`;
        }

        function looksLikeCustomBase(str) {
            return /^[ã‚-ã‚“ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒ³\s\r\n\t]*$/.test(str);
        }

        function triggerDownload(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }

        class App {
            constructor() {
                this.mode = 'encrypt';
                this.isProcessing = false;
                this.lastResult = null;
                this.importedFile = null;
                this.inputMime = 'application/octet-stream';
                this.processStartTime = 0;
                this.processedBytes = 0;
                this.totalBytes = 0;
                this.lastPlainBlob = null;
                this.lastPlainFileName = null;
                this.lastCipherBlob = null;
                this.lastCipherFileName = null;
                this.currentImageUrl = null;
                this.initElements();
                this.bindEvents();
                this.setupDragAndDrop();
                this.updateUI();
                window.appInstance = this;
            }

            initElements() {
                this.el = {
                    useCustomKey: document.getElementById('useCustomKey'),
                    keyInputContainer: document.getElementById('keyInputContainer'),
                    keyInput: document.getElementById('keyInput'),
                    toggleKeyVisibility: document.getElementById('toggleKeyVisibility'),
                    keyStrengthBar: document.getElementById('keyStrengthBar'),
                    keyStrengthText: document.getElementById('keyStrengthText'),
                    inputText: document.getElementById('inputText'),
                    inputLabel: document.getElementById('inputLabel'),
                    charCount: document.getElementById('charCount'),
                    inputInfo: document.getElementById('inputInfo'),
                    importFile: document.getElementById('importFile'),
                    outputText: document.getElementById('outputText'),
                    outputImage: document.getElementById('outputImage'),
                    outputLabel: document.getElementById('outputLabel'),
                    encryptButton: document.getElementById('encryptButton'),
                    decryptButton: document.getElementById('decryptButton'),
                    clearButton: document.getElementById('clearButton'),
                    copyButton: document.getElementById('copyButton'),
                    downloadButton: document.getElementById('downloadButton'),
                    showDetailsButton: document.getElementById('showDetailsButton'),
                    modeText: document.getElementById('modeText'),
                    loadingSpinner: document.getElementById('loadingSpinner'),
                    operationStatus: document.getElementById('operationStatus'),
                    dataSize: document.getElementById('dataSize'),
                    processingTime: document.getElementById('processingTime'),
                    toggleAdvanced: document.getElementById('toggleAdvanced'),
                    advancedOptions: document.getElementById('advancedOptions'),
                    saltInput: document.getElementById('saltInput'),
                    iterationsInput: document.getElementById('iterationsInput'),
                    chunkSize: document.getElementById('chunkSize'),
                    encryptOutputMode: document.getElementById('encryptOutputMode'),
                    detailsModal: document.getElementById('detailsModal'),
                    modalBackdrop: document.getElementById('modalBackdrop'),
                    closeModal: document.getElementById('closeModal'),
                    modalVersion: document.getElementById('modalVersion'),
                    modalIterations: document.getElementById('modalIterations'),
                    modalMime: document.getElementById('modalMime'),
                    modalNonce: document.getElementById('modalNonce'),
                    modalSalt: document.getElementById('modalSalt'),
                    dragOverlay: document.getElementById('dragOverlay'),
                    processProgress: document.getElementById('processProgress'),
                    progressFill: document.getElementById('progressFill'),
                    progressPercent: document.getElementById('progressPercent'),
                    processedSize: document.getElementById('processedSize'),
                    totalSize: document.getElementById('totalSize'),
                    remainingTime: document.getElementById('remainingTime')
                };
            }

            bindEvents() {
                this.el.useCustomKey.addEventListener('change', () => this.toggleKeyInput());
                this.el.keyInput.addEventListener('input', () => this.updateKeyStrength());
                this.el.toggleKeyVisibility.addEventListener('click', () => this.toggleKeyVisibility());
                this.el.inputText.addEventListener('input', () => this.updateCharCount());
                this.el.importFile.addEventListener('change', (e) => this.handleFileImport(e));
                this.el.encryptButton.addEventListener('click', () => this.safeOperation(this.handleEncrypt.bind(this)));
                this.el.decryptButton.addEventListener('click', () => this.safeOperation(this.handleDecrypt.bind(this)));
                this.el.clearButton.addEventListener('click', () => this.handleClear());
                this.el.copyButton.addEventListener('click', () => this.copyResult());
                this.el.downloadButton.addEventListener('click', () => this.downloadResult());
                this.el.showDetailsButton.addEventListener('click', () => this.showDetails());
                this.el.toggleAdvanced.addEventListener('click', () => this.toggleAdvanced());
                this.el.closeModal.addEventListener('click', () => this.hideDetails());
                this.el.modalBackdrop.addEventListener('click', () => this.hideDetails());
            }

            setupDragAndDrop() {
                const body = document.body;
                body.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.el.dragOverlay.style.display = 'flex';
                });
                body.addEventListener('dragleave', (e) => {
                    if (!body.contains(e.relatedTarget)) this.el.dragOverlay.style.display = 'none';
                });
                body.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.el.dragOverlay.style.display = 'none';
                    if (e.dataTransfer.files.length > 0) {
                        this.handleFileImport({ target: { files: e.dataTransfer.files } });
                    }
                });
            }

            async safeOperation(fn) {
                try {
                    await fn();
                    // åŠ å¯†/è§£å¯†å®Œæˆåå‘é€çœ‹æ¿å¨˜æ¶ˆæ¯
                    if (this.mode === 'encrypt') {
                        showMessage('çœ‹æ¿å¨˜: åŠ å¯†å®Œæˆå•¦ï¼æ•°æ®å®‰å…¨äº†ï¼', 'success');
                    } else {
                        showMessage('çœ‹æ¿å¨˜: è§£å¯†æˆåŠŸï¼æ•°æ®æ¢å¤å•¦ï¼', 'success');
                    }
                } catch (e) {
                    console.error('æ“ä½œå¤±è´¥:', e);
                    this.el.operationStatus.textContent = 'âœ— æ“ä½œå¤±è´¥';
                    this.el.operationStatus.className = 'text-red-600 font-medium';
                    this.showMessage(`æ“ä½œå¤±è´¥ï¼š${e.message}`, 'error');
                    this.hideLoading();
                }
            }

            toggleKeyInput() {
                this.el.keyInputContainer.classList.toggle('hidden', !this.el.useCustomKey.checked);
                this.updateKeyStrength();
            }

            toggleKeyVisibility() {
                const type = this.el.keyInput.type === 'password' ? 'text' : 'password';
                this.el.keyInput.type = type;
                this.el.toggleKeyVisibility.textContent = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
            }

            updateKeyStrength() {
                const pass = this.el.useCustomKey.checked ? this.el.keyInput.value : '';
                const strength = evaluateKeyStrength(pass);
                this.el.keyStrengthBar.style.width = strength.percent + '%';
                this.el.keyStrengthText.textContent = `å¼ºåº¦ï¼š${strength.text}`;
                this.el.keyStrengthText.className = `ml-2 text-xs font-medium ${strength.color}`;
            }

            updateCharCount() {
                const len = this.el.inputText.value.length;
                this.el.charCount.textContent = `${len} å­—ç¬¦`;
            }

            handleFileImport(e) {
                const file = e.target.files[0];
                if (!file) {
                    this.importedFile = null;
                    this.inputMime = 'application/octet-stream';
                    this.el.inputInfo.textContent = '';
                    this.el.charCount.textContent = '0 å­—ç¬¦';
                    return;
                }
                this.importedFile = file;
                this.inputMime = file.type || 'application/octet-stream';
                this.el.inputText.value = '';
                this.el.charCount.textContent = '';
                this.el.inputInfo.textContent = `å·²å¯¼å…¥ï¼š${file.name} (${formatBytes(file.size)})`;
            }

            toggleAdvanced() {
                const hidden = this.el.advancedOptions.classList.toggle('hidden');
                this.el.toggleAdvanced.textContent = hidden ? 'æ˜¾ç¤ºé«˜çº§é€‰é¡¹' : 'éšè—é«˜çº§é€‰é¡¹';
            }

            showLoading() {
                this.el.loadingSpinner.style.display = 'block';
                this.isProcessing = true;
                this.el.operationStatus.textContent = 'å¤„ç†ä¸­...';
                this.el.operationStatus.classList.add('processing');
                this.updateUI();
            }

            hideLoading() {
                this.el.loadingSpinner.style.display = 'none';
                this.isProcessing = false;
                this.el.operationStatus.classList.remove('processing');
                this.updateUI();
            }

            updateProgress(processed, total) {
                const percent = Math.min(100, Math.round((processed / total) * 100));
                this.el.progressFill.style.width = percent + '%';
                this.el.progressPercent.textContent = percent + '%';
                this.el.processedSize.textContent = formatBytes(processed);
                this.el.totalSize.textContent = formatBytes(total);
                const elapsed = (performance.now() - this.processStartTime) / 1000;
                if (elapsed > 1) {
                    const speed = processed / elapsed;
                    const remaining = (total - processed) / speed;
                    this.el.remainingTime.textContent = remaining > 0 && isFinite(remaining) ? formatTime(remaining) : 'å³å°†å®Œæˆ...';
                } else {
                    this.el.remainingTime.textContent = 'è®¡ç®—ä¸­...';
                }
            }

            updateUI() {
                this.el.modeText.textContent = this.mode === 'encrypt' ? 'å½“å‰æ¨¡å¼ï¼šåŠ å¯†' : 'å½“å‰æ¨¡å¼ï¼šè§£å¯†';
                this.el.inputLabel.textContent = this.mode === 'encrypt' ? 'è¾“å…¥æ˜æ–‡æˆ–ä»»æ„æ–‡ä»¶' : 'è¾“å…¥å¯†æ–‡æˆ–å¯¼å…¥.encæ–‡ä»¶';
                this.el.outputLabel.textContent = this.mode === 'encrypt' ? 'å¯†æ–‡ç»“æœ' : 'æ˜æ–‡/æ–‡ä»¶ç»“æœ';
                [this.el.encryptButton, this.el.decryptButton, this.el.clearButton].forEach(b => b.disabled = this.isProcessing);
            }

            getPassword() {
                if (this.el.useCustomKey.checked) {
                    if (!this.el.keyInput.value.trim()) throw new Error('å·²å¯ç”¨è‡ªå®šä¹‰å¯†é’¥ä½†æœªè¾“å…¥å¯†ç ');
                    return this.el.keyInput.value.trim();
                }
                return 'z7jgX9RwezqpY588dRphLRMTE3ie2uTX';
            }

            getSalt() {
                const val = this.el.saltInput.value.trim();
                if (val) {
                    if (!/^[0-9a-fA-F]+$/.test(val) || val.length % 2 !== 0) throw new Error('ç›å€¼å¿…é¡»ä¸ºæœ‰æ•ˆåå…­è¿›åˆ¶å­—ç¬¦ä¸²');
                    const arr = new Uint8Array(val.length / 2);
                    for (let i = 0; i < val.length; i += 2) arr[i/2] = parseInt(val.substr(i, 2), 16);
                    return arr;
                }
                return crypto.getRandomValues(new Uint8Array(16));
            }

            getIterations() {
                return Math.max(1000, Math.min(1000000, parseInt(this.el.iterationsInput.value) || 200000));
            }

            getChunkSize() {
                const mb = Math.max(1, Math.min(500, parseInt(this.el.chunkSize.value) || 20));
                const size = mb * 1024 * 1024;
                if (mb > 100) {
                    console.warn(`åˆ†å—å¤§å°${mb}MBè¾ƒå¤§ï¼Œå¯èƒ½å¢åŠ å†…å­˜å ç”¨ï¼Œå»ºè®®ä½¿ç”¨Chrome/Edgeå¤„ç†å¤§æ–‡ä»¶ã€‚`);
                }
                return size;
            }

            showMessage(msg, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type} show`;
                toast.textContent = msg;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            }

            updateImage(blob) {
                if (this.currentImageUrl) {
                    URL.revokeObjectURL(this.currentImageUrl);
                }
                this.currentImageUrl = URL.createObjectURL(blob);
                this.el.outputImage.src = this.currentImageUrl;
                this.el.outputImage.classList.remove('hidden');
            }

            async handleEncrypt() {
                this.mode = 'encrypt';
                this.processStartTime = performance.now();

                let writable = null;
                let chunks = [];

                try {
                    this.showLoading();
                    this.el.processProgress.classList.add('active');

                    let inputFile, fileSize, originalName = null;
                    if (this.importedFile) {
                        inputFile = this.importedFile;
                        fileSize = inputFile.size;
                        originalName = inputFile.name;
                    } else {
                        const text = this.el.inputText.value.trim();
                        if (!text) throw new Error('è¯·è¾“å…¥å†…å®¹æˆ–å¯¼å…¥æ–‡ä»¶');
                        const blob = new Blob([text], { type: 'text/plain' });
                        inputFile = new File([blob], 'text.txt');
                        fileSize = blob.size;
                        this.inputMime = 'text/plain';
                    }

                    let outputMode = this.el.encryptOutputMode.value;
                    if (outputMode === 'text' && fileSize > LARGE_TEXT_THRESHOLD) {
                        const confirmContinue = confirm(`æ–‡ä»¶è¾ƒå¤§ (${formatBytes(fileSize)})ï¼Œæ˜¾ç¤ºæ—¥æ–‡å¯†æ–‡ä¼šè†¨èƒ€çº¦37%ï¼Œå¯èƒ½å¯¼è‡´æµè§ˆå™¨å¡é¡¿ã€‚\nå»ºè®®åˆ‡æ¢ä¸º"ä¿å­˜ä¸ºæ–‡ä»¶"æ¨¡å¼ï¼Œæ˜¯å¦ç»§ç»­æ˜¾ç¤ºæ–‡æœ¬ï¼Ÿ`);
                        if (!confirmContinue) {
                            this.el.encryptOutputMode.value = 'file';
                            this.showMessage('å·²è‡ªåŠ¨åˆ‡æ¢ä¸ºä¿å­˜ä¸ºæ–‡ä»¶æ¨¡å¼', 'info');
                            outputMode = 'file';
                        }
                    }

                    const password = this.getPassword();
                    const salt = this.getSalt();
                    const iterations = this.getIterations();
                    const aesKey = await deriveKey(password, salt, iterations);

                    const fileNonce = crypto.getRandomValues(new Uint8Array(FILE_NONCE_LEN));

                    const mimeBytes = new TextEncoder().encode(this.inputMime);
                    const mimeLen = Math.min(mimeBytes.length, MAX_MIME_LEN);

                    const headerLen = 1 + 1 + 1 + 4 + 2 + 16 + FILE_NONCE_LEN + mimeLen + 1;
                    const header = new Uint8Array(headerLen);

                    let pos = 0;
                    header[pos++] = MAGIC_BYTE;
                    header[pos++] = CURRENT_VERSION;
                    header[pos++] = mimeLen;

                    const headerView = new DataView(header.buffer);
                    headerView.setUint32(pos, iterations, false);
                    pos += 4;

                    const chunkSizeMB = parseInt(this.el.chunkSize.value) || 20;
                    headerView.setUint16(pos, chunkSizeMB, false);
                    pos += 2;

                    header.set(salt, pos);
                    pos += 16;

                    header.set(fileNonce, pos);
                    pos += FILE_NONCE_LEN;

                    if (mimeLen > 0) {
                        header.set(mimeBytes.slice(0, mimeLen), pos);
                        pos += mimeLen;
                    }

                    header[pos++] = SEPARATOR_BYTE;

                    let suggestedName;
                    if (originalName) {
                        suggestedName = originalName.replace(/\.enc$/i, '') + '.enc';
                    } else {
                        suggestedName = getTimestampFilename('encrypted', '.enc');
                    }

                    const pickerOpts = {
                        suggestedName: suggestedName,
                        startIn: 'downloads',
                        types: [{
                            description: 'Encrypted File',
                            accept: { 'application/octet-stream': ['.enc'] }
                        }]
                    };

                    if (outputMode === 'file' && supportsSavePicker) {
                        const handle = await window.showSaveFilePicker(pickerOpts);
                        writable = await handle.createWritable();
                        await writable.write(header);
                    } else if (outputMode === 'file') {
                        chunks = [header];
                    }

                    const chunkSize = this.getChunkSize();
                    this.totalBytes = fileSize;
                    this.processedBytes = 0;
                    this.updateProgress(0, fileSize);

                    let counter = 0;

                    for (let offset = 0; offset < fileSize; offset += chunkSize) {
                        const end = Math.min(offset + chunkSize, fileSize);
                        const chunk = new Uint8Array(await inputFile.slice(offset, end).arrayBuffer());

                        const iv = new Uint8Array(GCM_IV_LEN);
                        iv.set(fileNonce, 0);
                        const ivView = new DataView(iv.buffer);
                        ivView.setUint32(8, counter, false);

                        const aad = new Uint8Array(4);
                        new DataView(aad.buffer).setUint32(0, counter, false);

                        const encrypted = await crypto.subtle.encrypt(
                            { name: "AES-GCM", iv, additionalData: aad, tagLength: 128 },
                            aesKey,
                            chunk
                        );

                        const encryptedWithTag = new Uint8Array(encrypted);

                        if (writable) {
                            await writable.write(encryptedWithTag);
                        } else {
                            chunks.push(encryptedWithTag);
                        }

                        counter++;
                        if (counter === 0xffffffff) throw new Error('æ–‡ä»¶è¿‡å¤§ï¼ŒGCM counter æº¢å‡º');

                        this.processedBytes = end;
                        this.updateProgress(this.processedBytes, this.totalBytes);
                        await new Promise(r => setTimeout(r, 0));
                    }

                    if (writable) {
                        await writable.close();
                        this.el.outputText.value = '[åŠ å¯†æˆåŠŸï¼å·²ä¿å­˜ä¸ºæ–‡ä»¶]';
                    } else if (outputMode === 'file') {
                        const fullBlob = new Blob(chunks);
                        triggerDownload(fullBlob, suggestedName);
                        this.el.outputText.value = '[åŠ å¯†æˆåŠŸï¼å·²è§¦å‘ä¸‹è½½]';
                    } else {
                        const fullCipher = new Uint8Array(headerLen + chunks.reduce((s, c) => s + c.length, 0));
                        fullCipher.set(header, 0);
                        let off = headerLen;
                        for (const c of chunks) {
                            fullCipher.set(c, off);
                            off += c.length;
                        }

                        const japaneseText = customBaseEncode(fullCipher);
                        this.el.outputText.value = japaneseText;
                        this.el.copyButton.textContent = 'ğŸ“‹ å¤åˆ¶å¯†æ–‡';
                        this.el.copyButton.classList.remove('hidden');
                        this.lastCipherBlob = new Blob([fullCipher]);
                        this.lastCipherFileName = suggestedName;
                        this.el.downloadButton.classList.remove('hidden');
                    }

                    this.el.outputText.classList.remove('hidden');
                    this.el.operationStatus.textContent = 'âœ“ åŠ å¯†æˆåŠŸ';
                    this.el.operationStatus.className = 'text-green-600 font-medium';
                    this.el.dataSize.textContent = formatBytes(fileSize);
                    this.el.processingTime.textContent = ((performance.now() - this.processStartTime) / 1000).toFixed(2) + ' ç§’';

                    this.lastResult = {
                        version: CURRENT_VERSION,
                        iterations,
                        mime: this.inputMime,
                        nonce: Array.from(fileNonce).map(b => b.toString(16).padStart(2,'0')).join(''),
                        salt: Array.from(salt).map(b => b.toString(16).padStart(2,'0')).join('')
                    };
                    this.el.showDetailsButton.classList.remove('hidden');
                    this.showMessage('åŠ å¯†å®Œæˆ', 'success');

                } catch (e) {
                    if (writable) await writable.abort().catch(() => {});
                    throw e;
                } finally {
                    this.hideLoading();
                    this.el.processProgress.classList.remove('active');
                }
            }

            async handleDecrypt() {
                this.mode = 'decrypt';
                this.processStartTime = performance.now();

                let writable = null;
                let memoryChunks = [];
                let finalBlob = null;
                let finalFileName = null;

                try {
                    this.showLoading();
                    this.el.processProgress.classList.add('active');

                    let inputFile = this.importedFile;
                    let decoded = null;
                    let originalName = null;

                    if (!inputFile) {
                        const input = this.el.inputText.value.trim();
                        if (!input) throw new Error('è¯·ç²˜è´´æ—¥æ–‡å¯†æ–‡æˆ–å¯¼å…¥.encæ–‡ä»¶');
                        if (!looksLikeCustomBase(input)) throw new Error('è¾“å…¥ä¸æ˜¯æœ‰æ•ˆçš„æ—¥æ–‡å¯†æ–‡ï¼Œè¯·æ£€æŸ¥');
                        decoded = customBaseDecode(input);
                        inputFile = {
                            slice(start, end) {
                                return new Blob([decoded.slice(start, end)]);
                            },
                            size: decoded.length
                        };
                    } else {
                        originalName = inputFile.name;
                    }

                    const headerSlice = await inputFile.slice(0, 1024).arrayBuffer();
                    const headerBytes = new Uint8Array(headerSlice);

                    let pos = 0;
                    if (headerBytes[pos++] !== MAGIC_BYTE) throw new Error('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šä¸æ˜¯æœ¬å·¥å…·ç”Ÿæˆçš„å¯†æ–‡');
                    const version = headerBytes[pos++];
                    if (version < 25 || version > CURRENT_VERSION) throw new Error(`ç‰ˆæœ¬ä¸å…¼å®¹ï¼šæ–‡ä»¶ç‰ˆæœ¬ ${version}ï¼Œå½“å‰å·¥å…·ç‰ˆæœ¬ ${CURRENT_VERSION}`);

                    const mimeLen = headerBytes[pos++];

                    if (pos + 4 > headerBytes.length) throw new Error('æ–‡ä»¶å¤´æŸåï¼šiterations æ•°æ®ä¸å®Œæ•´');
                    const headerView = new DataView(headerBytes.buffer);
                    const iterations = headerView.getUint32(pos, false);
                    pos += 4;

                    let chunkSize;
                    if (version >= 26) {
                        if (pos + 2 > headerBytes.length) throw new Error('æ–‡ä»¶å¤´æŸåï¼šchunkSize æ•°æ®ä¸å®Œæ•´');
                        const chunkSizeMB = headerView.getUint16(pos, false);
                        pos += 2;
                        chunkSize = chunkSizeMB * 1024 * 1024;
                    } else {
                        chunkSize = this.getChunkSize();
                    }

                    if (pos + 16 > headerBytes.length) throw new Error('æ–‡ä»¶å¤´æŸåï¼šsalt æ•°æ®ä¸å®Œæ•´');
                    const salt = headerBytes.slice(pos, pos + 16);
                    pos += 16;

                    if (pos + FILE_NONCE_LEN > headerBytes.length) throw new Error('æ–‡ä»¶å¤´æŸåï¼šnonce æ•°æ®ä¸å®Œæ•´');
                    const fileNonce = headerBytes.slice(pos, pos + FILE_NONCE_LEN);
                    pos += FILE_NONCE_LEN;

                    const mimeEnd = pos + mimeLen;
                    if (mimeEnd > headerBytes.length) throw new Error('æ–‡ä»¶å¤´æŸåï¼šMIME é•¿åº¦è¶…å‡ºèŒƒå›´');
                    const mimeType = mimeLen > 0 ? new TextDecoder().decode(headerBytes.slice(pos, mimeEnd)) : 'application/octet-stream';
                    pos = mimeEnd;

                    if (pos >= headerBytes.length || headerBytes[pos++] !== SEPARATOR_BYTE) throw new Error('æ–‡ä»¶å¤´æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘åˆ†éš”ç¬¦');

                    const headerSize = pos;

                    const password = this.getPassword();
                    const aesKey = await deriveKey(password, salt, iterations);

                    const ciphertextSize = inputFile.size - headerSize;

                    let fileExt = getExtensionFromMime(mimeType);
                    if (!fileExt && originalName) {
                        const m = originalName.match(/(\.[a-zA-Z0-9]{1,8})$/);
                        if (m) fileExt = m[1].toLowerCase();
                    }
                    if (!fileExt) fileExt = '.bin';

                    finalFileName = originalName 
                        ? originalName.replace(/\.enc$/i, '') + (originalName.replace(/\.enc$/i, '').endsWith(fileExt) ? '' : fileExt)
                        : getTimestampFilename('decrypted', fileExt);

                    const pickerOpts = {
                        suggestedName: finalFileName,
                        startIn: 'downloads',
                        types: [{
                            description: 'Decrypted File',
                            accept: mimeType ? { [mimeType]: [fileExt] } : { 'application/octet-stream': ['.bin'] }
                        }]
                    };

                    const isFileImport = this.importedFile !== null;
                    if (isFileImport && supportsSavePicker) {
                        const handle = await window.showSaveFilePicker(pickerOpts);
                        writable = await handle.createWritable();
                    }

                    this.totalBytes = ciphertextSize;
                    this.processedBytes = 0;
                    this.updateProgress(0, this.totalBytes);

                    let counter = 0;
                    let decryptedSize = 0;

                    for (let offset = headerSize; offset < inputFile.size; offset += chunkSize + GCM_TAG_LEN) {
                        const remaining = inputFile.size - offset;
                        if (remaining <= GCM_TAG_LEN) throw new Error('æ–‡ä»¶æŸåï¼šå‰©ä½™å­—èŠ‚ä¸è¶³è®¤è¯æ ‡ç­¾');

                        const ciphertextLen = Math.min(chunkSize, remaining - GCM_TAG_LEN);
                        const totalRead = ciphertextLen + GCM_TAG_LEN;

                        const chunkSlice = inputFile.slice(offset, offset + totalRead);
                        const chunkWithTag = new Uint8Array(await chunkSlice.arrayBuffer());

                        const iv = new Uint8Array(GCM_IV_LEN);
                        iv.set(fileNonce, 0);
                        const ivView = new DataView(iv.buffer);
                        ivView.setUint32(8, counter, false);

                        const aad = new Uint8Array(4);
                        new DataView(aad.buffer).setUint32(0, counter, false);

                        const decrypted = await crypto.subtle.decrypt(
                            { name: "AES-GCM", iv, additionalData: aad, tagLength: 128 },
                            aesKey,
                            chunkWithTag
                        );

                        const plainChunk = new Uint8Array(decrypted);
                        decryptedSize += plainChunk.length;

                        if (writable) {
                            await writable.write(plainChunk);
                        } else {
                            memoryChunks.push(plainChunk);
                        }

                        counter++;
                        if (counter === 0xffffffff) throw new Error('æ–‡ä»¶è¿‡å¤§ï¼ŒGCM counter æº¢å‡º');

                        this.processedBytes += ciphertextLen;
                        this.updateProgress(this.processedBytes, this.totalBytes);

                        if ((counter & 0x3) === 0) {
                            await Promise.resolve();
                        }
                    }

                    if (writable) {
                        await writable.close();
                        this.showMessage('è§£å¯†å®Œæˆï¼Œå·²ä¿å­˜ä¸ºæ–‡ä»¶', 'success');
                    } else {
                        const totalLen = memoryChunks.reduce((s, c) => s + c.length, 0);
                        const plaintext = new Uint8Array(totalLen);
                        let off = 0;
                        for (const c of memoryChunks) {
                            plaintext.set(c, off);
                            off += c.length;
                        }

                        finalBlob = new Blob([plaintext], { type: mimeType || 'application/octet-stream' });

                        if (mimeType.startsWith('text/') || isLikelyText(plaintext)) {
                            const text = new TextDecoder().decode(plaintext);
                            this.el.outputText.value = text.length > 100000 ? text.substring(0, 100000) + '\n\n...(å†…å®¹è¿‡é•¿ï¼Œå·²æˆªæ–­æ˜¾ç¤º)' : text;
                            this.el.outputText.classList.remove('hidden');
                            this.el.copyButton.textContent = 'ğŸ“‹ å¤åˆ¶æ˜æ–‡';
                            this.el.copyButton.classList.remove('hidden');
                        } else if (mimeType.startsWith('image/')) {
                            this.updateImage(finalBlob);
                        } else {
                            this.el.outputText.value = '[äºŒè¿›åˆ¶æ–‡ä»¶è§£å¯†å®Œæˆ]';
                            this.el.outputText.classList.remove('hidden');
                            this.lastPlainBlob = finalBlob;
                            this.lastPlainFileName = finalFileName;
                            this.el.downloadButton.classList.remove('hidden');
                        }

                        if (!supportsSavePicker && ciphertextSize > LARGE_TEXT_THRESHOLD) {
                            triggerDownload(finalBlob, finalFileName);
                        }
                    }

                    this.el.operationStatus.textContent = 'âœ“ è§£å¯†æˆåŠŸï¼ˆè®¤è¯é€šè¿‡ï¼‰';
                    this.el.operationStatus.className = 'text-green-600 font-medium';
                    this.el.dataSize.textContent = formatBytes(decryptedSize);
                    this.el.processingTime.textContent = ((performance.now() - this.processStartTime) / 1000).toFixed(2) + ' ç§’';

                    this.lastResult = {
                        version: CURRENT_VERSION,
                        iterations,
                        mime: mimeType,
                        nonce: Array.from(fileNonce).map(b => b.toString(16).padStart(2,'0')).join(''),
                        salt: Array.from(salt).map(b => b.toString(16).padStart(2,'0')).join('')
                    };
                    this.el.showDetailsButton.classList.remove('hidden');

                } catch (e) {
                    if (writable) await writable.abort().catch(() => {});
                    throw e;
                } finally {
                    this.hideLoading();
                    this.el.processProgress.classList.remove('active');
                }
            }

            copyResult() {
                navigator.clipboard.writeText(this.el.outputText.value).then(() => {
                    this.showMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                });
            }

            downloadResult() {
                const blob = this.lastPlainBlob || this.lastCipherBlob;
                const fileName = this.lastPlainFileName || this.lastCipherFileName;
                if (blob) {
                    triggerDownload(blob, fileName);
                }
            }

            showDetails() {
                if (!this.lastResult) return;
                this.el.modalVersion.textContent = this.lastResult.version;
                this.el.modalIterations.textContent = this.lastResult.iterations;
                this.el.modalMime.textContent = this.lastResult.mime;
                this.el.modalNonce.textContent = this.lastResult.nonce;
                this.el.modalSalt.textContent = this.lastResult.salt;
                this.el.detailsModal.classList.remove('hidden');
            }

            hideDetails() {
                this.el.detailsModal.classList.add('hidden');
            }

            handleClear() {
                this.el.useCustomKey.checked = false;
                this.el.keyInput.value = '';
                this.el.saltInput.value = '';
                this.el.iterationsInput.value = 200000;
                this.el.chunkSize.value = 20;
                this.el.encryptOutputMode.value = 'text';
                this.el.inputText.value = '';
                this.el.outputText.value = '';
                this.el.outputImage.src = '';
                this.el.outputText.classList.add('hidden');
                this.el.outputImage.classList.add('hidden');
                this.el.copyButton.classList.add('hidden');
                this.el.downloadButton.classList.add('hidden');
                this.el.charCount.textContent = '0 å­—ç¬¦';
                this.el.inputInfo.textContent = '';
                this.el.importFile.value = '';
                this.importedFile = null;
                this.el.dataSize.textContent = '-';
                this.el.processingTime.textContent = '-';
                this.el.operationStatus.textContent = 'å°±ç»ª';
                this.el.showDetailsButton.classList.add('hidden');
                this.toggleKeyInput();
                this.el.advancedOptions.classList.add('hidden');
                this.el.toggleAdvanced.textContent = 'æ˜¾ç¤ºé«˜çº§é€‰é¡¹';
                this.lastPlainBlob = null;
                this.lastCipherBlob = null;

                if (this.currentImageUrl) {
                    URL.revokeObjectURL(this.currentImageUrl);
                    this.currentImageUrl = null;
                }

                this.showMessage('å·²æ¸…ç©º', 'info');
            }
        }

        document.addEventListener('DOMContentLoaded', () => new App());
    </script>
</body>
</html>
